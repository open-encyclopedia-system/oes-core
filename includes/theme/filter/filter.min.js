(function(oesFilter,$){let currentFilterPostIDs=[];let selectedFilter=[];let filteredIDs=new Set;function setFilterVariable(){if(typeof oes_filter=="undefined")oes_filter=[]}function getAllIds(){const ids=new Set;$(".oes-post-filter-wrapper").each(function(){this.className.split(/\s+/).forEach(cls=>{if(cls.startsWith("oes-post-filter-")){const id=parseInt(cls.replace("oes-post-filter-",""),10);if(!isNaN(id))ids.add(id)}})});return ids}function getFacetFilteredIds(){const types=Object.keys(currentFilterPostIDs);if(!types.length)return null;let ids=new Set(currentFilterPostIDs[types[0]]);for(let i=1;i<types.length;i++){ids=intersectSets(ids,new Set(currentFilterPostIDs[types[i]]))}return ids}function getRangeFilteredIds(){const sliders=document.querySelectorAll(".oes-range-slider");if(!sliders.length)return null;let ids=new Set;sliders.forEach(slider=>{const[min,max]=slider.value.split(";").map(Number);const startMap=oes_filter[slider.dataset.start]||{};const stopMap=oes_filter[slider.dataset.end]||{};for(const[val,arr]of Object.entries(startMap)){const n=parseFloat(val);if(n>=min&&n<=max)arr.forEach(id=>ids.add(id))}for(const[val,arr]of Object.entries(stopMap)){const n=parseFloat(val);if(n>=min&&n<=max)arr.forEach(id=>ids.add(id))}});return ids.size?ids:null}function getAlphabetFilteredIds(){const active=document.querySelector(".oes-filter-abc.active");if(!active||active.dataset.filter==="all")return null;return new Set($(".oes-archive-wrapper[data-alphabet='"+active.dataset.filter+"'] .oes-post-filter-wrapper").map(function(){return parseInt(this.dataset.post)}).get())}function getPostTypeFilteredIds(){const active=document.querySelector(".oes-filter-post-type.active");if(!active||active.dataset.filter==="all")return null;return new Set($(".oes-post-type-filter-"+active.dataset.filter+" .oes-post-filter-wrapper").map(function(){return parseInt(this.dataset.post)}).get())}function updateVisibility(visibleIds){const $wrappers=$(".oes-archive-wrapper");const $posts=$(".oes-post-filter-wrapper");$wrappers.show();$posts.each(function(){const classes=this.className.split(/\s+/);let isVisible=false;for(const cls of classes){if(cls.startsWith("oes-post-filter-")){const id=parseInt(cls.replace("oes-post-filter-",""),10);if(!isNaN(id)&&visibleIds.has(id)){isVisible=true;break}}}$(this).toggle(isVisible)});$wrappers.each(function(){const $wrapper=$(this);const hasVisiblePosts=$wrapper.find(".oes-post-filter-wrapper:visible").length>0;$wrapper.toggle(hasVisiblePosts);const alphabetFilter=$('.oes-filter-abc[data-filter="'+this.dataset.alphabet+'"]');if(!hasVisiblePosts){alphabetFilter.addClass("inactive")}else{alphabetFilter.removeClass("inactive")}})}function intersectSets(a,b){if(!a&&!b)return new Set;if(!a)return b;if(!b)return a;const res=new Set;a.forEach(x=>{if(b.has(x))res.add(x)});return res}function updateFilterCount(){const allWrappers=$(".oes-archive-wrapper");let amount=0;if(allWrappers.length>0){amount=$(".oes-post-filter-wrapper:visible").length}else if(filteredIDs instanceof Set){amount=filteredIDs.size}$(".oes-archive-count-number").text(amount);$(".oes-archive-container-no-entries").toggle(amount===0);$(".oes-archive-count-label-singular").toggle(amount===1);$(".oes-archive-count-label-plural").toggle(amount!==1)}function updateFacetFilterCount(){setFilterVariable();const $facetFilters=$(".oes-archive-filter");const allWrappers=$(".oes-archive-wrapper");const activeTypes=Object.keys(oes_filter).filter(type=>$("#trigger_"+type).hasClass("active"));let visibleIds=new Set;const safeFilteredIds=filteredIDs instanceof Set?filteredIDs:new Set;if(allWrappers.length>0){safeFilteredIds.forEach(id=>{if($(".oes-post-filter-"+id+":visible").length>0){visibleIds.add(id)}})}else{visibleIds=safeFilteredIds}$facetFilters.each(function(){const $filter=$(this);const $countElem=$filter.children(".oes-filter-item-count");const type=$filter.data("type");const filter=$filter.data("filter");if($filter.hasClass("active")){if($countElem.length)$countElem.text("(-)");return}if(activeTypes.includes(type)){if($countElem.length)$countElem.text("(+)");$filter.parent().removeClass("inactive").show();return}const thisIds=oes_filter[type]&&Array.isArray(oes_filter[type][filter])?oes_filter[type][filter]:[];const newCount=thisIds.reduce((count,id)=>count+(visibleIds.has(id)?1:0),0);if($countElem.length)$countElem.text(`(${newCount})`);$filter.parent().toggleClass("inactive",newCount===0)})}function updateLocalStorage(visibleIds){localStorage.setItem("oesSearchResultsURL",window.location.href);localStorage.setItem("oesDisplayedIds",JSON.stringify([...visibleIds]));let selectedFilterStore=[];let i=0;for(const[type,ids]of Object.entries(selectedFilter)){selectedFilterStore[i]={};selectedFilterStore[i]["type"]=type;selectedFilterStore[i]["ids"]=ids;i++}localStorage.setItem("oesSelectedFilter",JSON.stringify(selectedFilterStore))}oesFilter.init=function(){if(typeof oes_filter==="undefined"){oes_filter=[]}const urlParams=new URLSearchParams(window.location.search);const params=Object.fromEntries(urlParams.entries());const resetFilters=params.oesf_reset==="true";const storedFilters=localStorage.getItem("oesSelectedFilter");let parsedFilters=null;if(!resetFilters&&storedFilters&&storedFilters!=="[]"){try{parsedFilters=JSON.parse(storedFilters)}catch(e){console.warn("Failed to parse saved filters from localStorage",e);parsedFilters=null}}else{parsedFilters=[];Object.entries(params).forEach(([key,value])=>{const filterName=key.startsWith("oesf_")?key.slice(5):key;if(oes_filter.hasOwnProperty(filterName)){const ids=value.includes(",")?value.split(","):[value];parsedFilters.push({type:filterName,ids:ids})}})}if(Array.isArray(parsedFilters)&&parsedFilters.length>0){parsedFilters.forEach(f=>{const type=f.type;const ids=Array.isArray(f.ids)?f.ids:[];if(oes_filter.hasOwnProperty(type)){ids.forEach(id=>oesFilter.apply(id,type))}})}else{oesFilter.applyAll()}};oesFilter.applyAll=function(){if(typeof oes_filter=="undefined")return;document.dispatchEvent(new CustomEvent("oes-filter-processing-started"));const facetIds=getFacetFilteredIds();const rangeIds=getRangeFilteredIds();const alphabetIds=getAlphabetFilteredIds();const typeIds=getPostTypeFilteredIds();filteredIDs=null;if(facetIds instanceof Set)filteredIDs=facetIds;if(rangeIds instanceof Set)filteredIDs=intersectSets(filteredIDs,rangeIds);if(alphabetIds instanceof Set)filteredIDs=intersectSets(filteredIDs,alphabetIds);if(typeIds instanceof Set)filteredIDs=intersectSets(filteredIDs,typeIds);const wrappersExist=document.querySelector(".oes-post-filter-wrapper");if(wrappersExist){if(!filteredIDs){filteredIDs=getAllIds()}else{filteredIDs=intersectSets(filteredIDs,getAllIds())}}const visibleIds=filteredIDs;updateVisibility(visibleIds);updateFacetFilterCount(visibleIds);updateFilterCount();updateLocalStorage(visibleIds);document.dispatchEvent(new CustomEvent("oes-filter-processed",{detail:{currentFilterPostIDs:currentFilterPostIDs,filteredIDs:filteredIDs}}))};oesFilter.apply=function(filter,type,$el){const $filterEl=$el||$(`.oes-archive-filter[data-type="${type}"][data-filter="${filter}"]`);$filterEl.hasClass("active")?oesFilter.remove(filter,type):oesFilter.add(filter,type,$filterEl);oesFilter.applyAll()};oesFilter.setState=function(filter,type,active){const $filterEl=$(`.oes-archive-filter[data-type="${type}"][data-filter="${filter}"]`);if(active&&!$filterEl.hasClass("active")){oesFilter.add(filter,type,$filterEl)}else if(!active&&$filterEl.hasClass("active")){oesFilter.remove(filter,type)}oesFilter.applyAll()};oesFilter.add=function(filter,type,$el){const filterItem=$el||$(`.oes-archive-filter[data-type="${type}"][data-filter="${filter}"]`);if(!filterItem.length){return}const filterText=filterItem.find("span").not(".oes-filter-item-count").first().text().trim();const activeFilterHTML=`
        <li>
            <a class="oes-active-filter-item" href="#" data-filter="${filter}" data-type="${type}">
                <span>${filterText}</span>
            </a>
        </li>`;$(".oes-active-filter-"+type).append(activeFilterHTML);const ids=oes_filter[type]&&oes_filter[type][filter]?Array.isArray(oes_filter[type][filter])?oes_filter[type][filter]:[oes_filter[type][filter]]:[];if(!currentFilterPostIDs[type]){currentFilterPostIDs[type]=[...ids]}else{currentFilterPostIDs[type]=currentFilterPostIDs[type].concat(ids)}filterItem.addClass("active");const list=$("#oes-filter-component-"+type).parent();list.addClass("active");if(selectedFilter[type]){if(!selectedFilter[type].includes(filter)){selectedFilter[type].push(filter)}}else{selectedFilter[type]=[filter]}};oesFilter.removeActiveFilter=function(filter,type){oesFilter.remove(filter,type);oesFilter.applyAll()};oesFilter.remove=function(filter,type){$(`.oes-active-filter-item[data-filter="${filter}"]`).parent().remove();$(`.oes-archive-filter[data-type="${type}"][data-filter="${filter}"]`).removeClass("active");if(!$(`#oes-filter-component-${type} .oes-archive-filter.active`).length){$(`#oes-filter-component-${type}`).parent().removeClass("active")}const activeFilters=$(`.oes-archive-filter[data-type="${type}"].active`);if(activeFilters.length){let updatedPostIds=[];activeFilters.each(function(){const filterId=this.dataset.filter;updatedPostIds=updatedPostIds.concat(oes_filter[type][filterId])});currentFilterPostIDs[type]=updatedPostIds}else{delete currentFilterPostIDs[type]}if(selectedFilter[type]){const index=selectedFilter[type].indexOf(filter);if(index>-1){selectedFilter[type].splice(index,1);if(!selectedFilter[type].length){delete selectedFilter[type]}}}if($(".oes-archive-filter.active").length===0){currentFilterPostIDs=[]}};oesFilter.applyAlphabet=function(el){const alphabetFilters=document.querySelectorAll(".oes-filter-abc");alphabetFilters.forEach(f=>{f.classList.remove("active");f.parentElement.classList.remove("active")});el.classList.add("active");el.parentElement.classList.add("active");oesFilter.applyAll()};oesFilter.applyPostTypes=function(filter){const countEl=document.querySelector(".oes-archive-count-number");const results=document.querySelectorAll(".oes-post-type-filter");if(filter==="all"){results.forEach(r=>r.style.display="")}else{results.forEach(r=>r.style.display="none");document.querySelectorAll(".oes-search-data-row.show").forEach(row=>row.classList.remove("show"));document.querySelectorAll(".oes-archive-plus").forEach(btn=>btn.setAttribute("aria-expanded","false"));const filtered=document.querySelectorAll(".oes-post-type-filter-"+filter);filtered.forEach(r=>r.style.display="")}if(countEl)updateFilterCount();document.querySelectorAll(".oes-filter-post-type").forEach(f=>f.classList.remove("active"));const activeFilter=document.querySelector(".oes-filter-post-type-"+filter);if(activeFilter)activeFilter.classList.add("active")};oesFilter.updateCount=function(){updateFilterCount()};$(".oes-filter-list-container").on("click",".oes-archive-filter",function(e){e.preventDefault();const $el=$(this);const type=$el.data("type");const filter=$el.data("filter");oesFilter.apply(filter,type,$el);const isActive=$el.hasClass("active");const filters=($el.data("additional")||"").toString().split(",").map(f=>f.trim()).filter(Boolean);filters.forEach(filterId=>{oesFilter.setState(filterId,type,isActive)})});$(".oes-active-filter-list").on("click",".oes-active-filter-item",function(e){e.preventDefault();const $el=$(this);const filter=$el.data("filter");const type=$el.data("type");oesFilter.removeActiveFilter(filter,type)})})(window.oesFilter||(window.oesFilter={}),jQuery);